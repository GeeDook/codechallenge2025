name: Test Participant Solution

on:
  pull_request:
    branches: [ main ]
    types: [ opened, synchronize, reopened ]

jobs:
  test-challenge:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up uv
        uses: astral-sh/setup-uv@v3
        with:
          enable-cache: true

      - name: Install dependencies
        run: make install

      - name: Create data directory
        run: mkdir -p data

      - name: Run challenge test
        id: test
        run: make test

      - name: Extract results
        id: results
        run: |
          cat <<EOF >> $GITHUB_OUTPUT
          time=$(grep '^time=' $GITHUB_OUTPUT | cut -d= -f2)
          accuracy=$(grep '^accuracy=' $GITHUB_OUTPUT | cut -d= -f2)
          correct=$(grep '^correct=' $GITHUB_OUTPUT | cut -d= -f2)
          score=$(grep '^score=' $GITHUB_OUTPUT | cut -d= -f2)
          EOF

      - name: Comment results on Pull Request
        uses: actions/github-script@v7
        with:
          script: |
            const time = parseFloat("${{ steps.results.outputs.time }}").toFixed(2);
            const accuracy = (parseFloat("${{ steps.results.outputs.accuracy }}") * 100).toFixed(1);

            const body = `## üß¨ #codechallenge2025 Results

            ‚è±Ô∏è **Execution Time**: ${time}s  
            ‚úÖ **Correct Matches**: ${{ steps.results.outputs.correct }}/35  
            üìä **Accuracy**: ${accuracy}%  
            üèÜ **Final Score**: ${{ steps.results.outputs.score }}/120
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });
